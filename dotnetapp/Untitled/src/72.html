<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\rogera\source\repos\dotnetstd\dnslib\factoryfloor\mqcomponent\processor\consumemqmessagesloop.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Text;
using System.Threading;
using DnsLib.AbstractArchitecture.AseArchitecture.Definitions;
using DnsLib.SysRes;
using RabbitMQ.Client;
using RabbitMQ.Client.Events;

namespace DnsLib.FactoryFloor.MqComponent.Processor
{
    #region using directives

    #endregion

    /// &lt;summary&gt;The consume mq messages loop.&lt;/summary&gt;
    public class ConsumeMqMessagesLoop
    {
        /// &lt;summary&gt;The ase message handler.&lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;The sender.&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;The engine.&lt;/param&gt;
        public delegate void AseMessageHandler(object sender, AseMessageEventArgs e);

        /// &lt;summary&gt;The ev rq tweet message.&lt;/summary&gt;
        public event AseMessageHandler EvRqTweetMessage;

        /// &lt;summary&gt;The ev rq tweet product create message.&lt;/summary&gt;
        public event AseMessageHandler EvRqTweetProductCreateMessage;

        /// &lt;summary&gt;The execute.&lt;/summary&gt;
        /// &lt;param name=&quot;engine&quot;&gt;The engine.&lt;/param&gt;
        public void Execute(IMqOperationsEngine engine)
        {
            var startMessage =
                $&quot;{typeof(ConsumeMqMessagesLoop)}.Execute(MqOperationsEngine) entered:{Environment.NewLine}\tengine-configured is : {engine.ConfiguredState}{Environment.NewLine} @ts = {DateTimeOffset.Now}&quot;;
            EnvironmentManager.WriteLine(&quot;message = {0}&quot;, startMessage);

            EnvironmentManager.FnDumpEnvironment();

            EnvironmentManager.WriteLine(&quot;establish connection&quot;);
            using (var connection = engine.CreateConnection())
            {
                EnvironmentManager.WriteLine(&quot;establish channel (CreateModel)&quot;);
                using (var channel = connection.CreateModel())
                {
                    EnvironmentManager.WriteLine($&quot;declare queue: {engine.QueueName}&quot;);
                    channel.QueueDeclare(engine.QueueName, true, false, false, null);

                    // put as params into engine

                    var counter = 0;

                    var consumer = new EventingBasicConsumer(channel);
                    consumer.Received += async (model, ea) =&gt;
                    {
                        EnvironmentManager.WriteLine($@&quot;New event: Received {ea.BasicProperties}&quot;);

                        var body = ea.Body;
                        var message = Encoding.UTF8.GetString(body);

                        EnvironmentManager.WriteLine(
                            $@&quot;{typeof(EventingBasicConsumer)} || counter {counter} of limit {engine.Limit}&quot;);
                        EnvironmentManager.WriteLine($&quot;{DateTimeOffset.Now} [x] Received, length: {message.Length}&quot;);
                        EnvironmentManager.WriteLine(&quot;\t[132/120:] {0} ...&quot;,
                            message.Substring(0, Math.Min(message.Length, 120)));


                        await engine.ProcessMessageAsync(message, this);
                        EnvironmentManager.WriteLine(
                            $&quot; [x] Processed, length: {message.Length}&quot;);
                        EnvironmentManager.WriteLine(&quot;\t[132/120:] {0} ...&quot;,
                            message.Substring(0, Math.Min(message.Length, 120)));


                        if (counter++ &lt;= engine.Limit) return;
                        EnvironmentManager.WriteLine(
                            $&quot;closing connection w/ limit {counter} w/ grace time {engine.GracetimeSeconds}&quot;);
                        // wait a bit to give eventhandlers time to execute
                        Thread.Sleep(TimeSpan.FromSeconds(engine.GracetimeSeconds));
                        // ReSharper disable once AccessToDisposedClosure
                        channel.Close();
                        EnvironmentManager.WriteLine(&quot;fin.&quot;);
                        // and end the program
                        Environment.Exit(0);
                    };

                    channel.BasicConsume(
                        engine.QueueName,
                        // noAck: true,
                        true,
                        consumer);

                    EnvironmentManager.WriteLine(@&quot; Press [enter] to exit.&quot;);
                    Console.ReadLine();
                }
            }
        }

        public void OnEvRqTweetMessage(AseMessageEventArgs e)
        {
            EvRqTweetMessage?.Invoke(this, e);
        }

        public void OnEvRqTweetProductCreateMessage(AseMessageEventArgs e)
        {
            EvRqTweetProductCreateMessage?.Invoke(this, e);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,10,0],[33,13,34,207,0],[35,13,35,73,0],[37,13,37,52,0],[39,13,39,66,0],[40,20,40,62,0],[41,13,41,14,0],[42,17,42,81,0],[43,24,43,62,0],[44,17,44,18,0],[45,21,45,88,0],[46,21,46,86,0],[50,21,50,37,0],[52,21,52,71,0],[53,21,54,21,0],[54,21,54,22,0],[54,22,55,25,0],[55,25,55,100,0],[55,100,57,25,0],[57,25,57,44,0],[57,44,58,25,0],[58,25,58,69,0],[58,69,60,25,0],[60,25,61,111,0],[61,111,62,25,0],[62,25,62,118,0],[62,118,63,25,0],[63,25,64,82,0],[64,82,67,25,0],[67,25,67,73,0],[67,73,68,25,0],[68,25,69,74,0],[69,74,70,25,0],[70,25,71,82,0],[71,82,74,25,0],[74,25,74,55,0],[74,55,74,56,0],[74,56,74,63,0],[74,63,75,25,0],[75,25,76,111,0],[76,111,78,25,0],[78,25,78,85,0],[78,85,80,25,0],[80,25,80,41,0],[80,41,81,25,0],[81,25,81,62,0],[81,62,83,25,0],[83,25,83,45,0],[83,45,84,21,0],[84,21,84,22,0],[84,22,84,23,0],[53,21,84,23,0],[86,21,90,35,0],[92,21,92,78,0],[93,21,93,40,0],[94,17,94,18,0],[95,13,95,14,0],[96,9,96,10,0],[99,9,99,10,0],[100,13,100,47,0],[101,9,101,10,0],[104,9,104,10,0],[105,13,105,60,0],[106,9,106,10,0]]);
    </script>
  </body>
</html>